f503b7c90bfd5819c08d25d0073f29ec
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const SizeStockView_1 = __importDefault(require("../../Application/Query/View/SizeStockView"));
const ProductView_1 = __importDefault(require("../../Application/Query/View/ProductView"));
const SCHEMA = 'itx';
const PRODUCT_TABLE = 'product';
const SIZE_STOCK_TABLE = 'stock';
const SALES_UNITS_TABLE = 'sales_units';
class PostgresProductFinder {
    constructor(postgresClient) {
        this.postgresClient = postgresClient;
    }
    findAll() {
        return __awaiter(this, void 0, void 0, function* () {
            const query = yield this.findAllQuery();
            if (query.length === 0) {
                console.error('Products not found');
                throw new Error('Products not found');
            }
            const products = query.map((product) => {
                const sizeStock = product.latest_stock.map((stock) => {
                    return new SizeStockView_1.default(stock.size, stock.stock);
                });
                return new ProductView_1.default(product.id, product.name, product.latest_sales, sizeStock);
            });
            return products;
        });
    }
    findAllQuery() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.postgresClient(PRODUCT_TABLE)
                .select(`${PRODUCT_TABLE}.id`, `${PRODUCT_TABLE}.name`, 'latest_sales.units as latest_sales', this.postgresClient.raw(`jsonb_agg(
				jsonb_build_object(
					'size', latest_stock.size,
					'stock', latest_stock.stock
				)
			) as latest_stock`))
                .withSchema(SCHEMA)
                .leftJoin(this.postgresClient.raw(`(
				SELECT product_id, units
				FROM ${SCHEMA}.${SALES_UNITS_TABLE}
				WHERE (product_id, updated_at) IN (
					SELECT product_id, MAX(updated_at)
					FROM ${SCHEMA}.${SALES_UNITS_TABLE}
					GROUP BY product_id
				)
			) as latest_sales`), `${PRODUCT_TABLE}.id`, 'latest_sales.product_id')
                .leftJoin(this.postgresClient.raw(`(
				SELECT product_id, size, stock
				FROM ${SCHEMA}.${SIZE_STOCK_TABLE}
				WHERE (product_id, size, updated_at) IN (
					SELECT product_id, size, MAX(updated_at)
					FROM ${SCHEMA}.${SIZE_STOCK_TABLE}
					GROUP BY product_id, size
				)
			) as latest_stock`), `${PRODUCT_TABLE}.id`, 'latest_stock.product_id')
                .groupBy(`${PRODUCT_TABLE}.id`, 'latest_sales.units');
        });
    }
}
exports.default = PostgresProductFinder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL25vZWxpYXBhcmFkYWNhc3Ryby9pdHgtYmFja2VuZC10b29sL3NyYy9JdHgvSW5mcmFzdHJ1Y3R1cmUvUXVlcnkvUG9zdGdyZXNQcm9kdWN0RmluZGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBRUEsK0ZBQXNFO0FBQ3RFLDJGQUFrRTtBQUVsRSxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUE7QUFDcEIsTUFBTSxhQUFhLEdBQUcsU0FBUyxDQUFBO0FBQy9CLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFBO0FBQ2hDLE1BQU0saUJBQWlCLEdBQUcsYUFBYSxDQUFBO0FBWXZDLE1BQXFCLHFCQUFxQjtJQUN6QyxZQUNrQixjQUFvQjtRQUFwQixtQkFBYyxHQUFkLGNBQWMsQ0FBTTtJQUNuQyxDQUFDO0lBRUUsT0FBTzs7WUFDWixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtZQUV2QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN2QixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUE7Z0JBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQTthQUNyQztZQUVELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUF3QixFQUFHLEVBQUU7Z0JBQ3hELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBc0IsRUFBRSxFQUFFO29CQUNyRSxPQUFPLElBQUksdUJBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtnQkFDbEQsQ0FBQyxDQUFDLENBQUE7Z0JBRUYsT0FBTyxJQUFJLHFCQUFXLENBQ3JCLE9BQU8sQ0FBQyxFQUFFLEVBQ1YsT0FBTyxDQUFDLElBQUksRUFDWixPQUFPLENBQUMsWUFBWSxFQUNwQixTQUFTLENBQ1QsQ0FBQTtZQUNGLENBQUMsQ0FBQyxDQUFBO1lBRUYsT0FBTyxRQUFRLENBQUE7UUFDaEIsQ0FBQztLQUFBO0lBRVksWUFBWTs7WUFDekIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQztpQkFDdkMsTUFBTSxDQUNOLEdBQUcsYUFBYSxLQUFLLEVBQ3JCLEdBQUcsYUFBYSxPQUFPLEVBQ3ZCLG9DQUFvQyxFQUNwQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQzs7Ozs7cUJBS04sQ0FBQyxDQUNuQjtpQkFDQSxVQUFVLENBQUMsTUFBTSxDQUFDO2lCQUNsQixRQUFRLENBQ1IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUM7O1dBRWhCLE1BQU0sSUFBSSxpQkFBaUI7OztZQUcxQixNQUFNLElBQUksaUJBQWlCOzs7cUJBR2xCLENBQUMsRUFDbkIsR0FBRyxhQUFhLEtBQUssRUFDckIseUJBQXlCLENBQ3pCO2lCQUNBLFFBQVEsQ0FDUixJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQzs7V0FFaEIsTUFBTSxJQUFJLGdCQUFnQjs7O1lBR3pCLE1BQU0sSUFBSSxnQkFBZ0I7OztxQkFHakIsQ0FBQyxFQUNuQixHQUFHLGFBQWEsS0FBSyxFQUNyQix5QkFBeUIsQ0FDekI7aUJBQ0EsT0FBTyxDQUFDLEdBQUcsYUFBYSxLQUFLLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtRQUN0RCxDQUFDO0tBQUE7Q0FDRDtBQXZFRCx3Q0F1RUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL25vZWxpYXBhcmFkYWNhc3Ryby9pdHgtYmFja2VuZC10b29sL3NyYy9JdHgvSW5mcmFzdHJ1Y3R1cmUvUXVlcnkvUG9zdGdyZXNQcm9kdWN0RmluZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtuZXggfSBmcm9tICdrbmV4J1xuaW1wb3J0IHsgUHJvZHVjdEZpbmRlciB9IGZyb20gJy4uLy4uL0FwcGxpY2F0aW9uL1F1ZXJ5L0ZpbmRlci9Qcm9kdWN0RmluZGVyJ1xuaW1wb3J0IFNpemVTdG9ja1ZpZXcgZnJvbSAnLi4vLi4vQXBwbGljYXRpb24vUXVlcnkvVmlldy9TaXplU3RvY2tWaWV3J1xuaW1wb3J0IFByb2R1Y3RWaWV3IGZyb20gJy4uLy4uL0FwcGxpY2F0aW9uL1F1ZXJ5L1ZpZXcvUHJvZHVjdFZpZXcnXG5cbmNvbnN0IFNDSEVNQSA9ICdpdHgnXG5jb25zdCBQUk9EVUNUX1RBQkxFID0gJ3Byb2R1Y3QnXG5jb25zdCBTSVpFX1NUT0NLX1RBQkxFID0gJ3N0b2NrJ1xuY29uc3QgU0FMRVNfVU5JVFNfVEFCTEUgPSAnc2FsZXNfdW5pdHMnXG5cbnR5cGUgTGF0ZXN0U3RvY2tUeXBlID0ge1xuXHRcdHNpemU6IHN0cmluZ1xuXHRcdHN0b2NrOiBudW1iZXJcblx0fVxudHlwZSBQcm9kdWN0UXVlcnlUeXBlID0ge1xuXHRpZDogbnVtYmVyXG5cdG5hbWU6IHN0cmluZ1xuXHRsYXRlc3Rfc2FsZXM6IG51bWJlclxuXHRsYXRlc3Rfc3RvY2s6IExhdGVzdFN0b2NrVHlwZVtdXG59XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQb3N0Z3Jlc1Byb2R1Y3RGaW5kZXIgaW1wbGVtZW50cyBQcm9kdWN0RmluZGVyIHtcblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSByZWFkb25seSBwb3N0Z3Jlc0NsaWVudDogS25leFxuXHQpIHt9XG5cblx0YXN5bmMgZmluZEFsbCgpOiBQcm9taXNlPFByb2R1Y3RWaWV3W10+IHtcblx0XHRjb25zdCBxdWVyeSA9IGF3YWl0IHRoaXMuZmluZEFsbFF1ZXJ5KClcblxuXHRcdGlmIChxdWVyeS5sZW5ndGggPT09IDApIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ1Byb2R1Y3RzIG5vdCBmb3VuZCcpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1Byb2R1Y3RzIG5vdCBmb3VuZCcpXG5cdFx0fVxuXG5cdFx0Y29uc3QgcHJvZHVjdHMgPSBxdWVyeS5tYXAoKHByb2R1Y3Q6UHJvZHVjdFF1ZXJ5VHlwZSApID0+IHtcblx0XHRcdGNvbnN0IHNpemVTdG9jayA9IHByb2R1Y3QubGF0ZXN0X3N0b2NrLm1hcCgoc3RvY2s6IExhdGVzdFN0b2NrVHlwZSkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gbmV3IFNpemVTdG9ja1ZpZXcoc3RvY2suc2l6ZSwgc3RvY2suc3RvY2spXG5cdFx0XHR9KVxuXG5cdFx0XHRyZXR1cm4gbmV3IFByb2R1Y3RWaWV3KFxuXHRcdFx0XHRwcm9kdWN0LmlkLFxuXHRcdFx0XHRwcm9kdWN0Lm5hbWUsXG5cdFx0XHRcdHByb2R1Y3QubGF0ZXN0X3NhbGVzLFxuXHRcdFx0XHRzaXplU3RvY2tcblx0XHRcdClcblx0XHR9KVxuXG5cdFx0cmV0dXJuIHByb2R1Y3RzXG5cdH1cblxucHJpdmF0ZSBhc3luYyBmaW5kQWxsUXVlcnkoKSB7XG5cdHJldHVybiB0aGlzLnBvc3RncmVzQ2xpZW50KFBST0RVQ1RfVEFCTEUpXG5cdFx0LnNlbGVjdChcblx0XHRcdGAke1BST0RVQ1RfVEFCTEV9LmlkYCwgXG5cdFx0XHRgJHtQUk9EVUNUX1RBQkxFfS5uYW1lYCxcblx0XHRcdCdsYXRlc3Rfc2FsZXMudW5pdHMgYXMgbGF0ZXN0X3NhbGVzJyxcblx0XHRcdHRoaXMucG9zdGdyZXNDbGllbnQucmF3KGBqc29uYl9hZ2coXG5cdFx0XHRcdGpzb25iX2J1aWxkX29iamVjdChcblx0XHRcdFx0XHQnc2l6ZScsIGxhdGVzdF9zdG9jay5zaXplLFxuXHRcdFx0XHRcdCdzdG9jaycsIGxhdGVzdF9zdG9jay5zdG9ja1xuXHRcdFx0XHQpXG5cdFx0XHQpIGFzIGxhdGVzdF9zdG9ja2ApLFxuXHRcdClcblx0XHQud2l0aFNjaGVtYShTQ0hFTUEpXG5cdFx0LmxlZnRKb2luKFxuXHRcdFx0dGhpcy5wb3N0Z3Jlc0NsaWVudC5yYXcoYChcblx0XHRcdFx0U0VMRUNUIHByb2R1Y3RfaWQsIHVuaXRzXG5cdFx0XHRcdEZST00gJHtTQ0hFTUF9LiR7U0FMRVNfVU5JVFNfVEFCTEV9XG5cdFx0XHRcdFdIRVJFIChwcm9kdWN0X2lkLCB1cGRhdGVkX2F0KSBJTiAoXG5cdFx0XHRcdFx0U0VMRUNUIHByb2R1Y3RfaWQsIE1BWCh1cGRhdGVkX2F0KVxuXHRcdFx0XHRcdEZST00gJHtTQ0hFTUF9LiR7U0FMRVNfVU5JVFNfVEFCTEV9XG5cdFx0XHRcdFx0R1JPVVAgQlkgcHJvZHVjdF9pZFxuXHRcdFx0XHQpXG5cdFx0XHQpIGFzIGxhdGVzdF9zYWxlc2ApLFxuXHRcdFx0YCR7UFJPRFVDVF9UQUJMRX0uaWRgLFxuXHRcdFx0J2xhdGVzdF9zYWxlcy5wcm9kdWN0X2lkJ1xuXHRcdClcblx0XHQubGVmdEpvaW4oXG5cdFx0XHR0aGlzLnBvc3RncmVzQ2xpZW50LnJhdyhgKFxuXHRcdFx0XHRTRUxFQ1QgcHJvZHVjdF9pZCwgc2l6ZSwgc3RvY2tcblx0XHRcdFx0RlJPTSAke1NDSEVNQX0uJHtTSVpFX1NUT0NLX1RBQkxFfVxuXHRcdFx0XHRXSEVSRSAocHJvZHVjdF9pZCwgc2l6ZSwgdXBkYXRlZF9hdCkgSU4gKFxuXHRcdFx0XHRcdFNFTEVDVCBwcm9kdWN0X2lkLCBzaXplLCBNQVgodXBkYXRlZF9hdClcblx0XHRcdFx0XHRGUk9NICR7U0NIRU1BfS4ke1NJWkVfU1RPQ0tfVEFCTEV9XG5cdFx0XHRcdFx0R1JPVVAgQlkgcHJvZHVjdF9pZCwgc2l6ZVxuXHRcdFx0XHQpXG5cdFx0XHQpIGFzIGxhdGVzdF9zdG9ja2ApLFxuXHRcdFx0YCR7UFJPRFVDVF9UQUJMRX0uaWRgLFxuXHRcdFx0J2xhdGVzdF9zdG9jay5wcm9kdWN0X2lkJ1xuXHRcdClcblx0XHQuZ3JvdXBCeShgJHtQUk9EVUNUX1RBQkxFfS5pZGAsICdsYXRlc3Rfc2FsZXMudW5pdHMnKVxuXHR9XG59XG4iXSwidmVyc2lvbiI6M30=
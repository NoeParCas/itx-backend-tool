0e6b8ec9af018ccea25c36efb5afcca4
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const QueryBuilderMock_1 = __importDefault(require("../Mocks/QueryBuilderMock"));
const PostgresProductFinder_1 = __importDefault(require("../../../../src/Itx/Infrastructure/Query/PostgresProductFinder"));
const ProductView_1 = __importDefault(require("../../../../src/Itx/Application/Query/View/ProductView"));
const SizeStockView_1 = __importDefault(require("../../../../src/Itx/Application/Query/View/SizeStockView"));
const ProductNotFoundException_1 = __importDefault(require("../../../../src/Itx/Domain/Exceptions/ProductNotFoundException"));
describe('PostgresProductFinder', () => {
    const queryBuilder = (0, QueryBuilderMock_1.default)();
    const QUERY_RESULT = [
        {
            id: 1,
            name: 'Product 1',
            latest_sales: 10,
            latest_stock: [
                { size: 'S', stock: 5 },
                { size: 'M', stock: 3 },
                { size: 'L', stock: 2 }
            ]
        },
        {
            id: 2,
            name: 'Product 2',
            latest_sales: 20,
            latest_stock: [
                { size: 'S', stock: 0 },
                { size: 'M', stock: 3 },
                { size: 'L', stock: 0 }
            ]
        }
    ];
    const EXPECTED_FINDER_RESULT = [
        new ProductView_1.default(1, 'Product 1', 10, [
            new SizeStockView_1.default('S', 5),
            new SizeStockView_1.default('M', 3),
            new SizeStockView_1.default('L', 2)
        ]),
        new ProductView_1.default(2, 'Product 2', 20, [
            new SizeStockView_1.default('S', 0),
            new SizeStockView_1.default('M', 3),
            new SizeStockView_1.default('L', 0)
        ])
    ];
    it('should return all updated product information', () => __awaiter(void 0, void 0, void 0, function* () {
        const knexMock = jest.fn().mockReturnValue(queryBuilder);
        const productFinder = new PostgresProductFinder_1.default(knexMock);
        jest.spyOn(productFinder, 'findAllQuery').mockResolvedValue(QUERY_RESULT);
        const result = yield productFinder.findAll();
        expect(result).toEqual(EXPECTED_FINDER_RESULT);
    }));
    it('should throw an error if no products are found', () => __awaiter(void 0, void 0, void 0, function* () {
        const knexMock = jest.fn().mockReturnValue(queryBuilder);
        const productFinder = new PostgresProductFinder_1.default(knexMock);
        jest.spyOn(productFinder, 'findAllQuery').mockResolvedValue([]);
        yield expect(productFinder.findAll()).rejects.toThrow(ProductNotFoundException_1.default);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL25vZWxpYXBhcmFkYWNhc3Ryby9pdHgtYmFja2VuZC10b29sL3Rlc3RzL2plc3QvSW5mcmFzdHJ1Y3R1cmUvUXVlcnkvUG9zdGdyZXNQcm9kdWN0RmluZGVyLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFDQSxpRkFBMkQ7QUFDM0QsMkhBQWtHO0FBQ2xHLHlHQUFnRjtBQUNoRiw2R0FBb0Y7QUFDcEYsOEhBQXFHO0FBRXJHLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDdEMsTUFBTSxZQUFZLEdBQUcsSUFBQSwwQkFBbUIsR0FBRSxDQUFBO0lBQzFDLE1BQU0sWUFBWSxHQUFHO1FBQ3BCO1lBQ0MsRUFBRSxFQUFFLENBQUM7WUFDTCxJQUFJLEVBQUUsV0FBVztZQUNqQixZQUFZLEVBQUUsRUFBRTtZQUNoQixZQUFZLEVBQUU7Z0JBQ2IsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7Z0JBQ3ZCLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO2dCQUN2QixFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRTthQUN2QjtTQUNEO1FBQ0Q7WUFDQyxFQUFFLEVBQUUsQ0FBQztZQUNMLElBQUksRUFBRSxXQUFXO1lBQ2pCLFlBQVksRUFBRSxFQUFFO1lBQ2hCLFlBQVksRUFBRTtnQkFDYixFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRTtnQkFDdkIsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7Z0JBQ3ZCLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO2FBQ3ZCO1NBQ0Q7S0FDRCxDQUFBO0lBQ0QsTUFBTSxzQkFBc0IsR0FBRztRQUM5QixJQUFJLHFCQUFXLENBQ2QsQ0FBQyxFQUNELFdBQVcsRUFDWCxFQUFFLEVBQ0Y7WUFDQyxJQUFJLHVCQUFhLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUN6QixJQUFJLHVCQUFhLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUN6QixJQUFJLHVCQUFhLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUN6QixDQUNEO1FBQ0QsSUFBSSxxQkFBVyxDQUNkLENBQUMsRUFDRCxXQUFXLEVBQ1gsRUFBRSxFQUNGO1lBQ0MsSUFBSSx1QkFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDekIsSUFBSSx1QkFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDekIsSUFBSSx1QkFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDekIsQ0FDRDtLQUNELENBQUE7SUFFRCxFQUFFLENBQUMsK0NBQStDLEVBQUUsR0FBUyxFQUFFO1FBQzlELE1BQU0sUUFBUSxHQUFJLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFxQixDQUFBO1FBQzdFLE1BQU0sYUFBYSxHQUFHLElBQUksK0JBQXFCLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUE7UUFFekUsTUFBTSxNQUFNLEdBQUcsTUFBTSxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUE7UUFFNUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO0lBQy9DLENBQUMsQ0FBQSxDQUFDLENBQUE7SUFFRixFQUFFLENBQUMsZ0RBQWdELEVBQUUsR0FBUyxFQUFFO1FBQy9ELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFvQixDQUFBO1FBQzNFLE1BQU0sYUFBYSxHQUFHLElBQUksK0JBQXFCLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUE7UUFFL0QsTUFBTSxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxrQ0FBd0IsQ0FBQyxDQUFBO0lBQ2hGLENBQUMsQ0FBQSxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbm9lbGlhcGFyYWRhY2FzdHJvL2l0eC1iYWNrZW5kLXRvb2wvdGVzdHMvamVzdC9JbmZyYXN0cnVjdHVyZS9RdWVyeS9Qb3N0Z3Jlc1Byb2R1Y3RGaW5kZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBLbmV4IH0gZnJvbSAna25leCdcbmltcG9ydCBnZXRRdWVyeUJ1aWxkZXJNb2NrIGZyb20gJy4uL01vY2tzL1F1ZXJ5QnVpbGRlck1vY2snXG5pbXBvcnQgUG9zdGdyZXNQcm9kdWN0RmluZGVyIGZyb20gJy4uLy4uLy4uLy4uL3NyYy9JdHgvSW5mcmFzdHJ1Y3R1cmUvUXVlcnkvUG9zdGdyZXNQcm9kdWN0RmluZGVyJ1xuaW1wb3J0IFByb2R1Y3RWaWV3IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9JdHgvQXBwbGljYXRpb24vUXVlcnkvVmlldy9Qcm9kdWN0VmlldydcbmltcG9ydCBTaXplU3RvY2tWaWV3IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9JdHgvQXBwbGljYXRpb24vUXVlcnkvVmlldy9TaXplU3RvY2tWaWV3J1xuaW1wb3J0IFByb2R1Y3ROb3RGb3VuZEV4Y2VwdGlvbiBmcm9tICcuLi8uLi8uLi8uLi9zcmMvSXR4L0RvbWFpbi9FeGNlcHRpb25zL1Byb2R1Y3ROb3RGb3VuZEV4Y2VwdGlvbidcblxuZGVzY3JpYmUoJ1Bvc3RncmVzUHJvZHVjdEZpbmRlcicsICgpID0+IHtcblx0Y29uc3QgcXVlcnlCdWlsZGVyID0gZ2V0UXVlcnlCdWlsZGVyTW9jaygpIFxuXHRjb25zdCBRVUVSWV9SRVNVTFQgPSBbXG5cdFx0e1xuXHRcdFx0aWQ6IDEsXG5cdFx0XHRuYW1lOiAnUHJvZHVjdCAxJyxcblx0XHRcdGxhdGVzdF9zYWxlczogMTAsXG5cdFx0XHRsYXRlc3Rfc3RvY2s6IFtcblx0XHRcdFx0eyBzaXplOiAnUycsIHN0b2NrOiA1IH0sXG5cdFx0XHRcdHsgc2l6ZTogJ00nLCBzdG9jazogMyB9LFxuXHRcdFx0XHR7IHNpemU6ICdMJywgc3RvY2s6IDIgfVxuXHRcdFx0XVxuXHRcdH0sXG5cdFx0e1xuXHRcdFx0aWQ6IDIsXG5cdFx0XHRuYW1lOiAnUHJvZHVjdCAyJyxcblx0XHRcdGxhdGVzdF9zYWxlczogMjAsXG5cdFx0XHRsYXRlc3Rfc3RvY2s6IFtcblx0XHRcdFx0eyBzaXplOiAnUycsIHN0b2NrOiAwIH0sXG5cdFx0XHRcdHsgc2l6ZTogJ00nLCBzdG9jazogMyB9LFxuXHRcdFx0XHR7IHNpemU6ICdMJywgc3RvY2s6IDAgfVxuXHRcdFx0XVxuXHRcdH1cblx0XVxuXHRjb25zdCBFWFBFQ1RFRF9GSU5ERVJfUkVTVUxUID0gW1xuXHRcdG5ldyBQcm9kdWN0Vmlldyhcblx0XHRcdDEsXG5cdFx0XHQnUHJvZHVjdCAxJyxcblx0XHRcdDEwLFxuXHRcdFx0W1xuXHRcdFx0XHRuZXcgU2l6ZVN0b2NrVmlldygnUycsIDUpLFxuXHRcdFx0XHRuZXcgU2l6ZVN0b2NrVmlldygnTScsIDMpLFxuXHRcdFx0XHRuZXcgU2l6ZVN0b2NrVmlldygnTCcsIDIpXG5cdFx0XHRdXG5cdFx0KSxcblx0XHRuZXcgUHJvZHVjdFZpZXcoXG5cdFx0XHQyLFxuXHRcdFx0J1Byb2R1Y3QgMicsXG5cdFx0XHQyMCxcblx0XHRcdFtcblx0XHRcdFx0bmV3IFNpemVTdG9ja1ZpZXcoJ1MnLCAwKSxcblx0XHRcdFx0bmV3IFNpemVTdG9ja1ZpZXcoJ00nLCAzKSxcblx0XHRcdFx0bmV3IFNpemVTdG9ja1ZpZXcoJ0wnLCAwKVxuXHRcdFx0XVxuXHRcdClcblx0XVxuXG5cdGl0KCdzaG91bGQgcmV0dXJuIGFsbCB1cGRhdGVkIHByb2R1Y3QgaW5mb3JtYXRpb24nLCBhc3luYyAoKSA9PiB7XG5cdFx0Y29uc3Qga25leE1vY2sgPSAoamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShxdWVyeUJ1aWxkZXIpIGFzIHVua25vd24pIGFzIEtuZXhcblx0XHRjb25zdCBwcm9kdWN0RmluZGVyID0gbmV3IFBvc3RncmVzUHJvZHVjdEZpbmRlcihrbmV4TW9jaylcblxuXHRcdGplc3Quc3B5T24ocHJvZHVjdEZpbmRlciwgJ2ZpbmRBbGxRdWVyeScpLm1vY2tSZXNvbHZlZFZhbHVlKFFVRVJZX1JFU1VMVCkgXG5cdFx0XG5cdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvZHVjdEZpbmRlci5maW5kQWxsKClcblxuXHRcdGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoRVhQRUNURURfRklOREVSX1JFU1VMVClcblx0fSlcblxuXHRpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIG5vIHByb2R1Y3RzIGFyZSBmb3VuZCcsIGFzeW5jICgpID0+IHtcblx0XHRjb25zdCBrbmV4TW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUocXVlcnlCdWlsZGVyKSBhcyB1bmtub3duIGFzIEtuZXhcblx0XHRjb25zdCBwcm9kdWN0RmluZGVyID0gbmV3IFBvc3RncmVzUHJvZHVjdEZpbmRlcihrbmV4TW9jaylcblxuXHRcdGplc3Quc3B5T24ocHJvZHVjdEZpbmRlciwgJ2ZpbmRBbGxRdWVyeScpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSBcblxuXHRcdGF3YWl0IGV4cGVjdChwcm9kdWN0RmluZGVyLmZpbmRBbGwoKSkucmVqZWN0cy50b1Rocm93KFByb2R1Y3ROb3RGb3VuZEV4Y2VwdGlvbilcblx0fSlcbn0pXG4iXSwidmVyc2lvbiI6M30=